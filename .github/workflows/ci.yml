name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize]

env:
  UV_CACHE_DIR: /tmp/.uv-cache

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup | Backend | Restore uv cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
            uv-${{ runner.os }}

      - name: Setup | Frontend | Restore pnpm cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/pnpm
          key: pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
            pnpm-${{ runner.os }}

      - name: Setup | Mise-en-place
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2025.12.13 # [default: latest] mise version to install
          install: true # [default: true] run `mise install`
          cache: true # [default: true] cache mise using GitHub's cache
          experimental: true # [default: false] enable experimental features

      - name: Analyze | Run static code analysis
        run: just analyze

  test:
    name: Unit Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup | Backend | Restore uv cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
            uv-${{ runner.os }}

      - name: Setup | Frontend | Restore pnpm cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/pnpm
          key: pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
            pnpm-${{ runner.os }}

      - name: Setup | Mise-en-place
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2025.12.13 # [default: latest] mise version to install
          install: true # [default: true] run `mise install`
          cache: true # [default: true] cache mise using GitHub's cache
          experimental: true # [default: false] enable experimental features

      - name: Test | Run all unit tests
        run: just unit-test
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup | Force correct release branch on workflow sha
        run: git checkout -B ${{ github.ref_name }}

      - name: Setup | Backend | Restore uv cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
            uv-${{ runner.os }}

      - name: Setup | Frontend | Restore pnpm cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/pnpm
          key: pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
            pnpm-${{ runner.os }}

      - name: Setup | Mise-en-place
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2025.12.13 # [default: latest] mise version to install
          install: true # [default: true] run `mise install`
          cache: true # [default: true] cache mise using GitHub's cache
          experimental: true # [default: false] enable experimental features

      - name: Setup | Setup docker compose
        uses: docker/setup-compose-action@e79596b1b4769557c41cc0bb1e796ebe62acd639

      - name: Continuous Integration
        id: ci
        run: just ci

      - name: Collect artifacts
        env:
          NEW_VERSION: ${{ steps.ci.outputs.version }}
        run: just artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: artifacts
          path: artifacts/

    outputs:
      new-release-detected: ${{ steps.ci.outputs.released }}
      new-release-version: ${{ steps.ci.outputs.version }}
      new-release-tag: ${{ steps.ci.outputs.tag }}
      new-release-is-prerelease: ${{ steps.ci.outputs.is_prerelease }}

      # Disable until docker-compose/mongodb setup is complete
  test-e2e:
    name: End-to-end Testing
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
        contents: read
    env:
      NEW_VERSION: ${{ needs.ci.outputs.new-release-version }}
      TAG: ${{ needs.ci.outputs.new-release-version }}
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache
          key: cypress-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Setup | Frontend | Restore pnpm cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.cache/pnpm
          key: pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-${{ hashFiles('frontend/pnpm-lock.yaml') }}
            pnpm-${{ runner.os }}

      - name: Setup | Mise-en-place
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          version: 2025.12.13 # [default: latest] mise version to install
          install: true # [default: true] run `mise install`
          cache: true # [default: true] cache mise using GitHub's cache
          experimental: true # [default: false] enable experimental features

      - name: Setup | Setup docker compose
        uses: docker/setup-compose-action@23d018c8d3d7324668ae2253ab48526ce0fc2bad

      - name: Setup | Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: artifacts
          path: artifacts/

      - name: Setup | Load artifacts
        run: just load

      - name: Setup | Pnpm
        run: just frontend pnpm-install

      - name: Setup | Cypress PNPM Patch
        run: cp frontend/pnpm-lock.yaml frontend/package-lock.json

      - name: Setup | Bring environment up
        run: just up

      - name: Test | Cypress end-to-end tests
        uses: cypress-io/github-action@0f330ebf0d60f87608ed72f1d6232e5644aa3171
        with:
          working-directory: frontend
          config: baseUrl=http://localhost:8080

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: test-artifacts
          if-no-files-found: ignore
          path: |
            frontend/test/downloads/
            frontend/test/screenshots/
            frontend/test/videos/

      - name: Teardown | Bring environment down
        if: always()
        run: just down
